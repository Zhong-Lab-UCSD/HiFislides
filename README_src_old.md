# Workflow

Note that here we use dummy codes just to provide and overview of the main steps of the workflow. More information can be found [here](https://docs.google.com/document/d/1MvXPgTVzzeAEnmRXDRuaJMY-U_ENorQMPzqpLVOJWA0/edit#).

The data processing is performed separately with two shell scripts for library 1 of spatial barcodes and library 2 of HiFi-Slide read pairs:

- **`spatial_barcode_processing.sh`**: The output files from this are saved into a folder named `flowcell_ID`. The entire log of this workflow with the executed commands and the timestamps is saved into a file named `flowcell_ID.log`
- **`HiFi_processing_pipeline.sh`**: steps 1-7 below. The output files from this are saved into a folder named `sample_name`. The entire log of this workflow with the executed commands and the timestamps is saved into a file named `sample_name.log`.

These scripts can be found [./bin/src_old](./bin/src_old).

## Deduplication of spatial barcodes (L1R1) and BWA index creation

This step is related to the flowcell library (library 1). It is independendent on the HiFi-Slide library.

```
flowcell_type="NextSeq"
flowcell="AAAL33WM5"

surfdedup \
$surface \
*_L1R1.fastq.gz > L1R1_dedup.fasta 2>L1R1_dup.txt
```
**Arguments**  
1. Identifier of the surface on recycled flowcell (`$surface` is automatically generated by the script using input parameters `flowcell_type` and `flowcell`). For example, `AAAL33WM5:1:1` indicates that the deduplication will be performed on the top surface (surface 1) of lane 1 of flowcell AAAL33WM5. In case of MiniSeq, we do not know if the tissue is on the top or bottom surface, therefore only `AAAL33WM5:1:` would be inputted here to consider both the surfaces.
2. The filename identifier of several L1R1 fastq files.

**Purpose**  
Remove redundant spatial barcodes. This script reads raw reads from recycled flow cell and adds "_N" to the identifier of each read, where N is the number of times the read is found on the surface (i.e. one spatial barcode could be found at N different coordinates on the surface). This script considered only reads from the surface identified by argument 1. 

**Output**  
The output of surfdedup includes two files:

1. `AAAL33WM5.L1R1_dedup.fasta`: fasta file with deduplicated read sequences (obtained from STDOUT). 
2. `AAAL33WM5.L1R1_dup.txt`: txt file listing all the read identifiers that shared the same read sequence (obtained from STDERR). Note that when N reads shared the same sequence, only 1 of the N read identifiers would be randomly chosen and printed to `AAAL33WM5.L1R1_dedup.fasta` while the remaining N - 1 read identifiers would be shown in N - 1 rows in `AAAL33WM5.L1R1_dup.txt`.

Then, we create bwa index from `AAAL33WM5.L1R1_dedup.fasta`:
```
bwa index \
-p AAAL33WM5.L1R1_dedup \
AAAL33WM5.L1R1_dedup.fasta
```

## 1. Preprocessing of HiFi-Slide R2 reads  

By design, HiFi-Slide R2 reads contain the sequences of the tissue RNA (RNA end of the read pair). 

It is possible that HiFi-Slide R2 sequencing reads the cDNA fragment but unintendedly reads through the fragment from one end to the other end. In other words, HiFi-Slide R2 could mistakenly include a portion of R1 in the recycled flow cell. To identify such cases, we search for overlap between L2R1 and L2R2 using the software PEAR (v0.9.6, minimum overlap size = 10 bp) and we filter out such L2R2 reads. 

Next, we trim Illumina Read 1 primers, polyG and polyX tails in L2R2 using the software fastp (v0.23.2). Note that besides trimming, fastp also reduces the number of reads because it filters out reads that are too short.


### Filter out L2R2 overlapping L2R1 (PEAR)

```
pear \
-f L2R1.fastq \
-r L2R2.fastq \
-v 10 \
-j 32 \
-o L2R2_pear
```

**Arguments**  
- `-f`: Name of the file with the forward paired-end reads.
- `-r`: Name of the file with the reverse paired-end reads.
- `-v`: Minimum overlap size (default: 10).
- `-j`: Number of threads.
- `-o`: Basename of the output files.

**Output**  
The software produces several fastq files with different contents. For our purposes, we are interested in `unassembled.reverse.fastq`, which contains the L2R2 reads not overlapping L2R1.


### Trimming Illumina Read 1 primers, polyG, polyX tails (FASTP)

```
fastp \
-i L2R2.pear_filter.fastq \
-o L2R2.fastp_filter.fastq \
-h L2R2.fastp_filter.log.html \
-j L2R2.fastp_filter.log.json \
--trim_poly_g \
--trim_poly_x \
--disable_quality_filtering \
--thread 16
```

**Output**  
Fastq file of preprocessed L2R2 reads `L2R2.fastp_filter.fastq` that will go into the following mapping steps.


## 2. Mapping HiFi-Slide R2 reads

We used STAR to align HiFi-Slide R2 reads to the genome.

For STAR, we set `--outFilterScoreMinOverLread 0` and `--outFilterMatchNminOverLread 0` as in [SeqScope](https://github.com/leeju-umich/Cho_Xi_Seqscope/blob/main/script/align.sh).

```
STAR \
--genomeDir $STAR_INDEX \
--readFilesIn L2R2.fastp_filter.fastq \
--outSAMtype BAM Unsorted \
--outReadsUnmapped Fastx \
--outSAMattributes All \
--outFileNamePrefix $L2R2_GENOME_DIR/L2R2_genome. \
--sjdbGTFfile gencode.v41.annotation.gtf \
--outFilterScoreMinOverLread 0 \
--outFilterMatchNminOverLread 0 \
--runThreadN 32
```

Next, uniquely mapped reads are selected using Samtools.

```
samtools view -@ 32 -b -h -q 255 \
-o $L2R2_GENOME_DIR/L2R2_genome.uniquelyAligned.out.bam \
$L2R2_GENOME_DIR/L2R2_genome.Aligned.out.bam 
```

Uniquely mapped reads are associated with annotated genes using bedtools. `gencode.v41.annotation.gene.gtf` is a modified version of the original GTF file `gencode.v41.annotation.gtf`, where only full gene body coordinates are kept (column 3 equal to "gene"), the additional rows (such as those related to exons for example) were discarded.

```
bedtools intersect \
-a $L2R2_GENOME_DIR/L2R2_genome.uniquelyAligned.out.bam \
-b $annotation_gtf_file_genes \
-wb -bed | cut -f 4,21 > $L2R2_GENOME_DIR/HiFi_L2R2_genome_temp.bed
```

`HiFi_L2R2_genome_temp.bed` shows each L2R2 read associated with the corresponding gene where gene information are formatted as in a GTF file. Additional processing will transform the file into a `HiFi_L2R2_genome_temp1.bed` with the following columns:

- Column 1: L2R2 read ID.
- Column 2: Gene ID.
- Column 3: Gene name.
- Column 4: Gene biotype.

Example:
```
MN00185:308:000H3YMVH:1:11104:22416:20248       ENSG00000261456.6       TUBB8   protein_coding
MN00185:308:000H3YMVH:1:22102:18602:1451        ENSG00000015171.20      ZMYND11 protein_coding
MN00185:308:000H3YMVH:1:11103:2816:12628        ENSG00000015171.20      ZMYND11 protein_coding
MN00185:308:000H3YMVH:1:12102:3409:4239         ENSG00000015171.20      ZMYND11 protein_coding
```

Additionally, we also include reads uniquely mapped but not overlapping annotated genes and we put `NA` for gene ID, name and biotype. 

```
bedtools intersect \
-a $L2R2_GENOME_DIR/L2R2_genome.uniquelyAligned.out.bam \
-b $annotation_gtf_file_genes \
-v -bed | cut -f 4 | awk '{print $0, "\tNA", "\tNA", "\tNA"}' > $L2R2_GENOME_DIR/HiFi_L2R2_genome_temp_2.bed
```

This allows to concatenate the outputs and sort by read ID to produce the output file `HiFi_L2R2_genome_ALL.sort.bed`.

```
cat $L2R2_GENOME_DIR/HiFi_L2R2_genome_temp_1.bed $L2R2_GENOME_DIR/HiFi_L2R2_genome_temp_2.bed | sort -k 1 --parallel=$N_THREADS -S 20G > $L2R2_GENOME_DIR/HiFi_L2R2_genome_ALL.sort.bed
```

## 3. Align HiFi-Slide R1 reads to deduplicated spatial barcodes

Aligner BWA is used to map HiFi-Slide R1 reads (L2R1) `L2R1.fastq` to deduplicated spatial barcodes `L1R1_dedup.fasta`. The BWA alignment seed length is left as default. The output SAM file is processed directly by removing the header and only selecting aligned output reads (SAM flags 0 or 256).

```
bwa_seed_length=19

bwa mem \
-a \
-k $min_base_match \
-t 32 \
L1R1_dedup L2R1.fastq > 2>L2R1_L1R1_dedup.log | grep -v '^@' | awk -F"\t" '$2 == "0" || $2 == "256" { print $0 }' > $L2_DIR/L2R1_mapping/L2R1_L1R1_dedup_k$bwa_seed_length.sam
```

In the case of a flowcell coming from MiniSeq, there is an additional step where we count the number of HiFi-Slide R1 reads mapped to spatial barcodes on the top (AAAL33WM5:1:1) and bottom surface (AAAL33WM5:1:2) and then select the surface with the highest number of aligned reads. This subsetted SAM file will go to the following steps.


## 4. Select HiFi-Slide R1 reads where R2 reads map over the genome

At this step, we use the HiFi-Slide read ID to select L2R1 reads aligned to spatial barcodes (`L2R1_L1R1_dedup_k19.sam`) that have corresponding R2 ends (L2R2) mapped over the genome using the file generated at step 2 `HiFi_L2R2_genome_ALL.sort.bed`. This step produces a filtered SAM file `L2R1_L1R1_dedup.filter.sam`.

```
awk -F"\t" 'NR==FNR{a[$1]; next} FNR==0 || $1 in a' $L2R2_GENOME_DIR/HiFi_L2R2_genome_ALL.sort.bed $L2R1_L1R1_SAM > $L2R1_L1R1_SAM_FILTER
```

## 5. Match HiFi-Slide read pairs with spatial location

At this step we first select mapped HiFi-Slide R1 reads with the highest alignment score, then we match them with their spatial location.

```
python3 $BIN_DIR/hifiwrangling0.py \
L2R1_L1R1_dedup.filter.sam \
AAAL33WM5.L1R1_dup.txt \
1000 | sort -k 1 --parallel=$N_THREADS -S 20G > L2R1_L1R1.hifiwrangling0.sort.o
```

**Arguments**  
1. Output SAM file from BWA after filtering.  
2. The second output file from `surfdedup`.
3. The maximum number of spots (`N_max`) a read can be mapped on the surface.

**Purpose**   
Read the SAM file output and collect the spatial barcodes aligned with each HiFi-Slide R1 reads at the highest alignment score. If a HiFi-Slide R1 read was aligned with N spatial barcodes that tied at the highest score, all the N spatial barcodes will be outputted except when `N > N_max`. Spatial barcodes aligned with lower score would be discarded. These HiFi-Slide read pairs are considered as spatially resolved. Next, we print out the coordinates of all the aligned spatial barcodes on each tile. Notably, when multiple spatial barcodes share the same sequence but from different coordinates, we print out all their coordinates.

**Output**
Tab-separated file `L2R1_L1R1.hifiwrangling0.sort.o` sorted by read ID and with the following columns:

- Column 1: HiFi-Slide read ID.
- Column 2: Tile ID (only tiles under the ROI provided as input).
- Column 3: X-coord on the tile (columns).
- Column 4: Y-coord on the tile (rows).
- Column 5: N as the number of total spatial coordinates where this HiFi-Slide read could be aligned to spatial barcodes. This is used to "weight" HiFi-Slide reads. For example, if a HiFi-Slide read has N = 8, it would be counted as 1/8 at any of these 8 coordinates.
- Column 6: The highest alignment score for this read.

Example:
```
MN00185:308:000H3YMVH:1:21104:22534:6585        1308    20557   77594   4   score1
MN00185:308:000H3YMVH:1:21104:22534:6585        1308    7797    22530   4   score2
MN00185:308:000H3YMVH:1:21104:22534:6585        1209    30647   54019   4   score3
MN00185:308:000H3YMVH:1:21104:22534:6585        1308    18891   36353   4   score4
```


## 6. Integrate spatial coordinates and RNA information

We integrate the outcomes from the sections above to associate a spatial coordinate with each expressed gene/transcript. This is done by performing a `join` of the output tables above using the HiFi-Slide read identifiers (both files were previously sorted by read ID). First, we generate tables where each HiFi-Slide read ID is associated with a spatial coordinate (coming from step 1) and a genomic region (coming from step 2). Finally, we aggregate those tables to obtain a list of unique "spot-gene" pairs with the corresponding gene expression levels.

```
join -1 1 -2 1 -t $'\t' $L2R1_MAPPING_DIR/L2R1_L1R1.hifiwrangling0.sort.o $L2R2_GENOME_DIR/HiFi_L2R2_genome_ALL.sort.bed | cut -f 2,3,4,5,6,7,8 > HiFi_L2R2_genome_spatial.txt
```

Without the `cut` the first column would be the HiFi-Slide read ID (field used for `join`), however since we do not need this information anymore we prefer to remove that field before writing to output file to reduce memory occupation.

Tab-separated txt file with the following columns:

- Column 1: Tile ID.
- Column 2: X-coord on the tile (columns).
- Column 3: Y-coord on the tile (rows).
- Column 4: N as the number of total spatial coordinates where this HiFi-Slide read could be aligned to spatial barcodes.
- Column 5: Gene ID.
- Column 6: Gene name.
- Column 7: Gene biotype.

Example:

```
1109    45545   10979   2       ENSG00000230876.8       LINC00486       lncRNA
1109    45545   10979   4       ENSG00000230876.8       LINC00486       lncRNA
1109    13609   68183   1       ENSG00000230876.8       LINC00486       lncRNA
1109    14271   75095   22      ENSG00000230876.8       LINC00486       lncRNA
```

We then aggregate `HiFi_L2R2_genome_spatial.txt` to get unique (spot_i, gene_j) rows, and we calculate the expression level (counts) of gene_j in spot_i in this way: first we calculate `1/N` values in every row of `HiFi_L2R2_genome_spatial.txt`, then we sum the 1/N values corresponding to each (spot_i, gene_j) pair.

```
awk -F"\t" '{array[$1"\t"$2"\t"$3"\t"$5"\t"$6"\t"$7]+=1/$4} END { for (i in array) {print i"\t" array[i]}}' HiFi_L2R2_genome_spatial.txt > HiFi_L2R2_genome_spatial.final.txt
```

Tab-separated txt file `sample_name.HiFi_L2R2_genome_spatial.final.txt` with the following columns:

- Column 1: Tile ID.
- Column 2: X-coord on the tile (columns).
- Column 3: Y-coord on the tile (rows).
- Column 4: Gene ID.
- Column 5: Gene name.
- Column 6: Gene biotype.
- Column 7: Gene expression level (weighted counts).

Example:

```
1109    45545   10979   ENSG00000230876.8       LINC00486       lncRNA  0.75
1109    13609   68183   ENSG00000230876.8       LINC00486       lncRNA  1
1109    14271   75095   ENSG00000230876.8       LINC00486       lncRNA  0.04545455
```

## 7. Select spots in ROI after visual inspection of the image

```
ROI_TILES=$L2_DIR/ROI_tiles_1.txt
ROI_label="ROI_1"

awk -F"\t" 'NR==FNR{a[$1]; next} FNR==0 || $1 in a' $ROI_TILES HiFi_L2R2_genome_spatial.final.txt | awk -v OFS='\t' '{print $1"_"$2"_"$3, $1, $2, $3, $5, $6, $7}' | awk -F"\t" '{array[$1"\t"$2"\t"$3"\t"$4"\t"$5"\t"$6]+=$7} END { for (i in array) {print i"\t" array[i]}}' > HiFi_L2R2_genome_spatial.final.$ROI_label.txt
```

`ROI_tiles_1.txt` contains the list of tiles (each on a new line) that form the ROI. The output file is the same as `HiFi_L2R2_genome_spatial.final.txt` but only for those specific tiles. This reduces a lot the dimension of the output file to be used for data analysis.

## Various statistics

```
# Calculate the number of spots in each tile
awk -v OFS='\t' '{print $1, $1"_"$2"_"$3}' $L2R1_L2R2_INTEGRATE_DIR/HiFi_L2R2_genome_spatial.final.txt | awk '!seen[$2]++' | awk '{A[$1]++}END{for(i in A)print i,A[i]}' | awk -v OFS='\t' '{print $1, $2, $2/10000}' > $L2R1_L2R2_INTEGRATE_DIR/tile_spot_number_table.txt

# Calculate the number of genes in each tile
awk -v OFS='\t' '{print $1, $1"_"$5}' $L2R1_L2R2_INTEGRATE_DIR/HiFi_L2R2_genome_spatial.final.txt | awk '!seen[$2]++' | awk '{A[$1]++}END{for(i in A)print i,A[i]}' | awk -v OFS='\t' '{print $1, $2, $2/10000}' > $L2R1_L2R2_INTEGRATE_DIR/tile_gene_number_table.txt

# Calculate the total gene expression in each tile
awk -v OFS='\t' '{print $1, $7}' $L2R1_L2R2_INTEGRATE_DIR/HiFi_L2R2_genome_spatial.final.txt | awk -F"\t" '{array[$1]+=$2} END { for (i in array) {print i"\t" array[i]}}' | awk -v OFS='\t' '{print $1, $2, $2/10000}' > $L2R1_L2R2_INTEGRATE_DIR/tile_gene_expression_table.txt
```


## QC metrics

Several QC metrics are saved in tab-separated txt files named respectively:

- `flowcell_ID.QC_metrics.txt`.
- `sample_name.QC_metrics.txt`.








